name: "Foundry OKD: Update Client/App Images & Deploy Helm Release"

on:
  push:
    branches:
      - NR-BCWAT-40/cicd
    # paths:
    #   - client/**
    #   - backend/**
    #   - charts/app/**
  workflow_dispatch:

jobs:
  deploy_application:
    runs-on: ubuntu-latest
    steps:
      # Checkout Repository
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      # Connect to OnPrem WG
      - name: Set up WireGuard Connection
        uses: niklaskeerl/easy-wireguard-action@v2
        with:
          WG_CONFIG_FILE: ${{ secrets.FOUNDRY_ONPREM_WG_CONF }}

      # Install OC CLI - Despite OC Login Action specifying OC is installed
      # for Ubuntu Runners, this fails without the install:
      # --------------------------------
      # Run redhat-actions/oc-login@v1
      # Authenticating using token
      # Error: Error: Unable to locate executable file: oc. Please verify either the file path exists or the file can be found within a directory specified by the PATH environment variable. Also check the file mode to verify the file is executable.
      # --------------------------------
      - name: Install oc CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz oc
          sudo mv oc /usr/local/bin

      # This is for onPrem only
      # BC Gov Actions will use the OC Runner Action:
      # bcgov/action-oc-runner@5882b707c20135424f62202f80d56c1d243fd96c
      - name: Authenticate to OKD and set context
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OKD_SERVER }}
          openshift_token: ${{ secrets.FOUNDRY_OKD_TOKEN}}
          insecure_skip_tls_verify: true
          namespace: bcwat

      # Init OKD as Insecure Registry
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-config-inline: |
            [registry."${{ secrets.OKD_REGISTRY }}"]
              http = true
              insecure = true

      - name: Get OKD Registry Credentials
        run: |
          echo "USERNAME=$(oc whoami)" >> $GITHUB_OUTPUT
          echo "PASSWORD=$(oc whoami -t)" >> $GITHUB_OUTPUT

      - name: Log in to Docker Registry
        run: |
          echo "${{ steps.get-creds.outputs.PASSWORD }}" | docker login ${{ secrets.OKD_REGISTRY }} \
            --username ${{ steps.get-creds.outputs.USERNAME }} \
            --password-stdin

      - name: Build and Push Client Image to Docker Registry
        uses: docker/build-push-action@v5
        with:
          context: ./client
          push: true
          tags: ${{ secrets.OKD_REGISTRY }}/bcwat/nginx:latest

      - name: Build and Push API Image to Docker Registry
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.OKD_REGISTRY }}/bcwat/api:latest




